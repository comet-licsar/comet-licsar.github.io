<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>licsar_proc.python.LiCSAR_db.LiCSquery &mdash; COMET LiCSAR  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            COMET LiCSAR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wiki.html">LiCSAR Wiki (from gitlab)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Main LiCSAR Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../licsar_db/index.html">LiCSInfo db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../licsar_proc/index.html">LiCSAR proc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../licsar_framebatch/index.html">LiCSAR Framebatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../daz/index.html">daz</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../licsar_proc/apidoc.html">LiCSAR proc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../licsar_framebatch/apidoc.html">LiCSAR FrameBatch</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ciw.html">COMET InSAR Workshop Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cometmembers.html">COMET Members Information</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer comments and advices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation.html">Notes about documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation.html#admin-or-dev-comments">Admin or dev comments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">COMET LiCSAR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">licsar_proc.python.LiCSAR_db.LiCSquery</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for licsar_proc.python.LiCSAR_db.LiCSquery</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MySQL database query wrappers for LiCSAR processor</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="c1">#import pdb</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">shapely</span> <span class="kn">import</span> <span class="n">wkt</span><span class="p">,</span> <span class="n">wkb</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Local imports</span>
<span class="kn">import</span> <span class="nn">global_config</span> <span class="k">as</span> <span class="nn">gc</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1">#get tunnel or not</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span>
    <span class="c1">#parser.get(&#39;sqlinfo&#39;,&#39;use_tunnel&#39;)</span>
    <span class="n">use_tunnel</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sqlinfo&#39;</span><span class="p">,</span><span class="s1">&#39;use_tunnel&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">use_tunnel</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">dbfunctions</span> <span class="kn">import</span> <span class="n">Conn_tunnel_db</span> <span class="k">as</span> <span class="n">Conn_db</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning - ssh tunnel will be used - close it when finished&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">tunnel</span> <span class="o">=</span> <span class="n">Conn_db</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">dbfunctions</span> <span class="kn">import</span> <span class="n">Conn_db</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">Conn_db</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error parsing config, LiCSQuery is now useless&#39;</span><span class="p">)</span>
<span class="c1">#if conn == &#39;MYSQL ERROR&#39;:</span>
<span class="c1">#    print(&#39;No database connection could be established&#39;)</span>


<div class="viewcode-block" id="delete_burst_from_db"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.delete_burst_from_db">[docs]</a><span class="k">def</span> <span class="nf">delete_burst_from_db</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">onlyprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deletes the burst from database if it does not appear in a frame definition.</span>
<span class="sd">    Also cleans burst occurences in other tables, and removes all files related to the burst ID.</span>
<span class="sd">    For admins only!</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bidtanx (str): LiCSAR Burst ID (e.g. &#39;101_IW3_1360&#39;)</span>
<span class="sd">        onlyprint (bool): if True, it will only print the parts to be run with SET FOREIGN_KEY_CHECKS=0/1 - not solved</span>
<span class="sd">    </span>
<span class="sd">    Note: if onlyprint is needed, you may also want to import sys; backout=sys.stdout; sys.stdout = open(&#39;output.txt&#39;,&#39;wt&#39;); ...; sys.stdout=backout;</span>
<span class="sd">    Note for me: this way i created sql file, and then see cat lics_mysql.sh, to do mysql ... licsar_live &lt; sqlfile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bid</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="c1"># check if the burst is not used</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select * from polygs2bursts where bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyprint</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this burst is used within some frame(s) - cancelling&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># first of all, deleting all files that uses the burst, and their connection</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete f from files f inner join files2bursts fb on f.fid=fb.fid where fb.bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">onlyprint</span><span class="p">:</span>
        <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete fb,f from files f inner join files2bursts fb on fb.fid=f.fid where fb.bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1">#sql=&quot;SET FOREIGN_KEY_CHECKS=0;&quot;; do_query(sql) , True)</span>
    <span class="c1">#sql=&quot;SET FOREIGN_KEY_CHECKS=0; delete fb,f from files f inner join files2bursts fb on fb.fid=f.fid where fb.bid={}; SET FOREIGN_KEY_CHECKS=1;&quot;.format(bid)</span>
    <span class="c1">#sql=&quot;SET FOREIGN_KEY_CHECKS=1;&quot;</span>
    <span class="c1">#sql=&#39;delete from files2bursts where bid={};&#39;.format(bid)</span>
    <span class="c1"># ok, needs a workaround!!!!</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select fid from files2bursts where bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="n">fids</span><span class="o">=</span><span class="n">do_pd_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cleaning related files (LiCSAR will need to reingest them)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="si">{0}</span><span class="s1"> records of files associated with burst </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)),</span> <span class="n">bidtanx</span><span class="p">))</span>
        <span class="c1">#sql=&#39;delete from files2bursts where bid={};&#39;.format(bid)</span>
        <span class="c1">#num = do_query(sql, True)</span>
        <span class="c1"># need to do it separately, otherwise foreign key errors</span>
        <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">fids</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from files2bursts where fid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">fids</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from files where fid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="c1">#sql=&#39;delete fb,f from files f inner join files2bursts fb on fb.fid=f.fid where f.fid={};&#39;.format(fid)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#if num &gt; 0:</span>
    <span class="c1">#    print(&#39;deleted {} records of files using this burst&#39;.format(str(num)))</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from bursts2gis where bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from bursts2S1 where bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from bursts where bid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;burst successfully deleted&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no burst definition deleted - ERROR&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="delete_file_from_db"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.delete_file_from_db">[docs]</a><span class="k">def</span> <span class="nf">delete_file_from_db</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;abs_path&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deletes all occurences of given file from the DB</span>
<span class="sd">    (including links to jobs and bursts).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ff (str): file identifier (specified by &#39;col&#39;)</span>
<span class="sd">        col (str): specifies the identifier - options: fid, name, abs_path</span>
<span class="sd">    </span>
<span class="sd">    Note: col name is the filename without the tailing .zip</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select fid from files where </span><span class="si">{0}</span><span class="s1">=&quot;</span><span class="si">{1}</span><span class="s1">&quot;;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">do_pd_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
        <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from files2jobs where fid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from files2bursts where fid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;delete from files where fid=</span><span class="si">{}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<span class="k">def</span> <span class="nf">delete_frame_only</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs where polygs.polyid_name=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="c1">#res = do_query(sql, True)</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="clone_frame"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.clone_frame">[docs]</a><span class="k">def</span> <span class="nf">clone_frame</span><span class="p">(</span><span class="n">frameold</span><span class="p">,</span> <span class="n">framenew</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oldpolyid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">newpolyid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    copies frame definition to a new name (&#39;cloning&#39; of frame). not tested without admin rights...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DROP TABLE IF EXISTS temp_tb; CREATE TEMPORARY TABLE temp_tb ENGINE=MEMORY (SELECT * FROM polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frameold</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE temp_tb DROP polyid; update temp_tb set polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; where polyid_name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">framenew</span><span class="p">,</span> <span class="n">frameold</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;insert into polygs select NULL,t.* from temp_tb t;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select polyid from polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frameold</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql)</span>
        <span class="c1">#oldpolyid = sqlout2list(res)[0]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select polyid from polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">framenew</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="c1">#res = do_query(sql)</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1">#newpolyid = sqlout2list(res)[0]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;insert into polygs2gis (polyid, geom) select </span><span class="si">{0}</span><span class="s2">,s.geom from polygs2gis s where polyid=</span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">newpolyid</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">oldpolyid</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;insert into polygs2bursts (polyid, bid) select </span><span class="si">{0}</span><span class="s2">,bid from polygs2bursts where polyid=</span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">newpolyid</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">oldpolyid</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DROP TABLE IF EXISTS temp_tb;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>
        <span class="c1">#res = do_query(sql, True)</span>
        <span class="c1">#return True</span>
    <span class="c1">#return res</span>


<span class="k">def</span> <span class="nf">delete_frame_files</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="c1">#e.g. in case of messed up bursts, this should help:</span>
    <span class="n">sql</span><span class="o">=</span><span class="s2">&quot;SET FOREIGN_KEY_CHECKS=0; delete fb,f from files f inner join files2bursts fb on fb.fid=f.fid inner join polygs2bursts pb on fb.bid=pb.bid inner join polygs p on pb.polyid=p.polyid where p.polyid_name=&#39;</span><span class="si">{}</span><span class="s2">&#39;;SET FOREIGN_KEY_CHECKS=1;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="c1">#sql = &quot;delete from polygs where polygs.polyid_name=&#39;{}&#39;;&quot;.format(frame)</span>
    <span class="c1">#print(sql)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>



<span class="k">def</span> <span class="nf">rename_frame</span><span class="p">(</span><span class="n">frameold</span><span class="p">,</span> <span class="n">framenew</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update polygs set polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; where polyid_name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">framenew</span><span class="p">,</span> <span class="n">frameold</span><span class="p">)</span>
    <span class="c1">#print(sql)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#return True</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">rename_burst</span><span class="p">(</span><span class="n">bold</span><span class="p">,</span> <span class="n">bnew</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING, the operation of burst rename may cause inconsistencies (not tested deeply)&#39;</span><span class="p">)</span>
    <span class="n">bid_old</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bold</span><span class="p">)</span>
    <span class="n">bid_new</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bnew</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1">#change the burst in files2bursts</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update files2bursts set bid=</span><span class="si">{0}</span><span class="s2"> where bid=</span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid_new</span><span class="p">,</span> <span class="n">bid_old</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#change the burst in frame definitions</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update polygs2bursts set bid=</span><span class="si">{0}</span><span class="s2"> where bid=</span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid_new</span><span class="p">,</span> <span class="n">bid_old</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#remove bid_old from bursts</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from bursts where bid=</span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid_old</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">replace_bidtanx_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bidtanx_old</span><span class="p">,</span> <span class="n">bidtanx_new</span><span class="p">):</span>
    <span class="n">bid_old</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx_old</span><span class="p">)</span>
    <span class="n">bid_new</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx_new</span><span class="p">)</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update polygs2bursts set bid=</span><span class="si">{0}</span><span class="s2"> where bid=</span><span class="si">{1}</span><span class="s2"> and polyid=</span><span class="si">{2}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid_new</span><span class="p">,</span> <span class="n">bid_old</span><span class="p">,</span> <span class="n">polyid</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">do_pd_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">conn</span>
    <span class="c1">#if use_tunnel:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#else:</span>
        <span class="c1">#    conn = Conn_db()</span>
        <span class="c1">#if type(conn) == tuple:</span>
        <span class="c1">#    conn = conn[0]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">do_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">conn</span>
    <span class="c1"># execute MySQL query and return result</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#if use_tunnel:</span>
        <span class="c1">#else:</span>
        <span class="c1">#    conn = Conn_db()</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;MYSQL ERROR&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No database connection could be established to perform the following query: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;MYSQL ERROR&#39;</span>
        <span class="c1">#if type(conn) == tuple:</span>
        <span class="c1">#    conn = conn[0]</span>
        <span class="c1">#to reconnect potentially lost connection.. try it twice!</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">)</span>
                <span class="n">res_list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">res_list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rowcount</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">)</span>
                <span class="n">res_list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">res_list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rowcount</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unexpected MySQL error </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">res_list</span>


<span class="k">def</span> <span class="nf">close_db_and_tunnel</span><span class="p">(</span><span class="n">kill</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">use_tunnel</span><span class="p">:</span>
        <span class="c1">#print(&#39;debug - closing connection&#39;)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#&#39;MySQL connection perhaps already closed?&#39;)</span>
        <span class="k">if</span> <span class="n">kill</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;debug - killing connection&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">thread_id</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1">#print(&#39;debug - closing tunnel&#39;)</span>
        <span class="k">if</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="n">tunnel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ssh tunnel closed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&#39;there is no ssh tunnel established here&#39;)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#&#39;error closing db connection&#39;)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">connection_established</span><span class="p">():</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;SELECT VERSION();&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;MYSQL ERROR&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not establish database connection&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">check_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="c1"># checks if frame exists in database</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polyid_name from polygs &quot;</span> \
        <span class="s2">&quot;where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">geom_from_polygs2geom</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select AsText(geom) from polygs2gis where polyid=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#.decode(&#39;UTF-8&#39;)  --- this is needed in case of bit older version of MySQL</span>

<span class="k">def</span> <span class="nf">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select corner1_lat, corner1_lon, corner2_lat, corner2_lon, corner3_lat, corner3_lon,&quot;</span> \
    <span class="s2">&quot; corner4_lat, corner4_lon from bursts where bid_tanx = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#the coordinates are &#39;random&#39; so I do a loop to get valid polygon</span>
    <span class="n">lat_set</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="n">lon_set</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_set</span><span class="p">)):</span>
        <span class="n">lat_point_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lon_point_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lat_set</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lat_point_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error in coords, maybe mysql connection&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">lon_set</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">lon_point_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
        <span class="n">polygon_geom</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lon_point_list</span><span class="p">,</span> <span class="n">lat_point_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">polygon_geom</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">polygon_geom</span>


<span class="k">def</span> <span class="nf">get_polygon_from_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select corner1_lon, corner2_lon, corner3_lon, corner4_lon, &quot;</span> \
        <span class="s2">&quot;corner5_lon, corner6_lon, corner7_lon, corner8_lon, &quot;</span> \
        <span class="s2">&quot;corner9_lon, corner10_lon, corner11_lon, corner12_lon &quot;</span> \
        <span class="s2">&quot;from polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select corner1_lat, corner2_lat, corner3_lat, corner4_lat, &quot;</span> \
        <span class="s2">&quot;corner5_lat, corner6_lat, corner7_lat, corner8_lat, &quot;</span> \
        <span class="s2">&quot;corner9_lat, corner10_lat, corner11_lat, corner12_lat &quot;</span> \
        <span class="s2">&quot;from polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lons2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lats2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="n">lons</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="n">lons2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">lats</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="n">lats2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">lons2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lats2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lons2</span><span class="p">,</span><span class="n">lats2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">polygon</span>


<span class="k">def</span> <span class="nf">get_bursts_in_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># S1 file name can end on .zip, .SAFE or be just identifier..</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx from bursts &quot;</span> \
            <span class="s2">&quot;inner join files2bursts fb on fb.bid=bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join files on fb.fid=files.fid &quot;</span>\
            <span class="s2">&quot;where files.name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="c1"># takes frame, returns list with burstid, centre_lon and </span>
    <span class="c1"># centre_lat of all bursts in frame</span>
    <span class="n">frametest</span> <span class="o">=</span> <span class="n">check_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">frametest</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning!</span><span class="se">\n</span><span class="s1">Frame </span><span class="si">{0}</span><span class="s1"> not found in database&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx, bursts.centre_lon, &quot;</span>\
            <span class="s2">&quot;bursts.centre_lat from bursts &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on polygs2bursts.bid=bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span>\
            <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="c1"># takes frame, returns list with burstid, centre_lon and </span>
    <span class="c1"># centre_lat of all bursts in frame</span>
    <span class="n">frametest</span> <span class="o">=</span> <span class="n">check_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">frametest</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning!</span><span class="se">\n</span><span class="s1">Frame </span><span class="si">{0}</span><span class="s1"> not found in database&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx from bursts &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on polygs2bursts.bid=bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span>\
            <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_s1bursts_from_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">opass</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">s1bids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="n">s1bid</span> <span class="o">=</span> <span class="n">get_s1burst_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">opass</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s1bids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1bid</span><span class="p">)</span>
    <span class="n">s1bids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s1bids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s1bids</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_bids2S1</span><span class="p">():</span>
    <span class="c1"># one off function to link all bursts to the S1 bursts</span>
    <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;orb dir: &#39;</span><span class="o">+</span><span class="n">orb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">175</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;doing track &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">trackstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">trackstr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">trackstr</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="n">trackstr</span>
            <span class="n">trackstr</span> <span class="o">=</span> <span class="n">trackstr</span><span class="o">+</span><span class="n">orb</span>
            <span class="c1"># ok, but do it only for existing frames!</span>
            <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">get_bidtanxs_in_track</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="n">trackstr</span><span class="p">,</span> <span class="n">onlyFrames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
                <span class="n">bid</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s1bid</span> <span class="o">=</span> <span class="n">get_s1burst_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">orb</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;insert into bursts2S1 values (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bid</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">s1bid</span><span class="p">))</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error with burst ID &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>


<div class="viewcode-block" id="update_bids2S1_missing"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.update_bids2S1_missing">[docs]</a><span class="k">def</span> <span class="nf">update_bids2S1_missing</span><span class="p">(</span><span class="n">onlyprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Will try linking LiCSAR bursts to S1 burst definitions which are not linked yet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select b.bid_tanx from bursts b where b.bid not in ( select bid from bursts2S1 );&quot;</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyprint</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;identified </span><span class="si">{}</span><span class="s1"> unmatched bursts&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">aa</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyprint</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opass</span> <span class="o">=</span> <span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyprint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this burst has no linked file - cannot extract orbdir, trying to delete&#39;</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">delete_burst_from_db</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">onlyprint</span><span class="o">=</span><span class="n">onlyprint</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="n">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s1bid</span> <span class="o">=</span> <span class="n">get_s1burst_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">opass</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;insert into bursts2S1 values (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bid</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">s1bid</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyprint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error with burst ID &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trying to delete&#39;</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">delete_burst_from_db</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">onlyprint</span><span class="o">=</span><span class="n">onlyprint</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_s1burst_from_bidtanx"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.get_s1burst_from_bidtanx">[docs]</a><span class="k">def</span> <span class="nf">get_s1burst_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">only_geom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to match official S1 burst with the LiCSAR burst ID.</span>
<span class="sd">    It includes few checks: rel.orb. can be +-1, while keeping orbit direction,</span>
<span class="sd">    timing tolerance 1.5 s to find most probable matching burst,</span>
<span class="sd">    which centre is within 1 degree from the centre by the LiCSAR burst definition.</span>
<span class="sd">    The tolerance values can be stricter.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bidtanx (str): LiCSAR burst ID</span>
<span class="sd">        opass (str): orbit direction (&#39;A&#39;/&#39;D&#39; for ascending/descending pass)</span>
<span class="sd">        only_geom (bool): if True, function will return only polygon (shapely.geometry)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># e.g. &#39;2_IW1_6220&#39;</span>
    <span class="n">iw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bidtanx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">relorb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bidtanx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">relorb1</span> <span class="o">=</span> <span class="n">relorb</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">relorb2</span> <span class="o">=</span> <span class="n">relorb</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">relorb</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">extra_last</span> <span class="o">=</span> <span class="s1">&#39;or relorb = 175&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extra_last</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="n">tanx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bidtanx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span>
    <span class="c1"># set tolerance of 1.5 s</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select id, s1bid, relorb, tanx, ST_AsText(geometry) as geometry from s1bursts where iw = </span><span class="si">{0}</span><span class="s2"> and (relorb between </span><span class="si">{1}</span><span class="s2"> and </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3}</span><span class="s2">) and opass = &#39;</span><span class="si">{4}</span><span class="s2">&#39; and </span><span class="se">\</span>
<span class="s2">             (tanx between </span><span class="si">{5}</span><span class="s2"> and </span><span class="si">{6}</span><span class="s2">);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">iw</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">relorb1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">relorb2</span><span class="p">),</span> <span class="n">extra_last</span><span class="p">,</span> <span class="n">opass</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tanx</span><span class="o">-</span><span class="n">tol</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tanx</span><span class="o">+</span><span class="n">tol</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">do_pd_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># extra check using centre lat, lon:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select centre_lat, centre_lon from bursts where bid_tanx = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s1">&#39;POINT(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">burst_centres</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="s1">&#39;centre_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">burst_centres</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">center</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># units are degrees! so i will limit to up to 1 deg (VERY tolerant here, but might be important for polar areas?)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">centre_distance</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;centre_distance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_geom</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span></div>


<span class="k">def</span> <span class="nf">get_s1b_geom_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span>
    <span class="c1"># e.g. &#39;2_IW1_6220&#39;</span>
    <span class="k">return</span> <span class="n">get_s1burst_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">opass</span><span class="p">,</span> <span class="n">only_geom</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    sql_q = &quot;select centre_lat, centre_lon from bursts where bid_tanx = &#39;{0}&#39;;&quot;.format(bidtanx)</span>
<span class="sd">    center = do_query(sql_q)[0]</span>
<span class="sd">    center = &#39;POINT(&#39;+str(center[1])+&#39; &#39;+str(center[0])+&#39;)&#39;</span>
<span class="sd">    sql_q = &quot;select ST_AsText(geometry) from s1bursts where iw = {0} and (relorb between {1} and {2} {3}) and opass = &#39;{4}&#39; and \</span>
<span class="sd">             ST_CONTAINS(geometry, ST_GEOMFROMTEXT(&#39;{5}&#39;));&quot;.format(str(iw), str(relorb1), str(relorb2), extra_last, opass, center)</span>
<span class="sd">    a = do_query(sql_q)[0][0]</span>
<span class="sd">    return wkt.loads(a)</span>
<span class="sd">    &#39;&#39;&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">ok, let&#39;s check which bursts were not mapped:</span>
<span class="sd">sql = &#39;select bid_tanx from bursts where bid not in (select bid from bursts2S1);&#39;</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">get_bidtanxs_in_track</span><span class="p">(</span><span class="n">track</span> <span class="o">=</span> <span class="s1">&#39;001A&#39;</span><span class="p">,</span> <span class="n">onlyFrames</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="c1"># takes trackid (e.g. &#39;001A&#39;), returns list with burstid, centre_lon and </span>
    <span class="k">if</span> <span class="n">onlyFrames</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx from bursts &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on polygs2bursts.bid=bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span>\
            <span class="s2">&quot;where polygs.polyid_track=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx from bursts where bid_tanxtk = </span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frame_files_period</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span> <span class="n">only_file_title</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1"># takes frame and two datetime.date objects and returns list returns</span>
    <span class="c1"># polygon name, aquisition date, file name and file path for all files </span>
    <span class="c1"># in frame in the given time period</span>
    <span class="c1">#</span>
    <span class="c1"># the ordering is important here due to new versions of files</span>
    <span class="c1"># simply put, ESA recomputes some slcs times to times and the newer</span>
    <span class="c1"># (better) version is again ingested to NLA and licsinfo. We should</span>
    <span class="c1"># use only the newer version files.</span>
    <span class="c1">#</span>
    <span class="c1"># this cannot be: and files.abs_path not like &#39;%metadata_only%&#39; &quot;\</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">only_file_title</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polygs.polyid_name, date(files.acq_date), &quot;</span> \
            <span class="s2">&quot;files.name, files.abs_path from files &quot;</span> \
            <span class="s2">&quot;inner join files2bursts on files.fid=files2bursts.fid &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on files2bursts.bid=polygs2bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span> \
            <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span> \
            <span class="s2">&quot;and date(files.acq_date) between &#39;</span><span class="si">{1}</span><span class="s2">&#39; and &#39;</span><span class="si">{2}</span><span class="s2">&#39; &quot;</span>\
            <span class="s2">&quot;and (files.pol=&#39;VV&#39; or files.pol=&#39;HH&#39;) &quot;</span>\
            <span class="s2">&quot;order by files.acq_date asc, files.name asc, files.proc_date desc, files.date_added desc;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct files.name from files &quot;</span> \
            <span class="s2">&quot;inner join files2bursts on files.fid=files2bursts.fid &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on files2bursts.bid=polygs2bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span> \
            <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span> \
            <span class="s2">&quot;and date(files.acq_date) between &#39;</span><span class="si">{1}</span><span class="s2">&#39; and &#39;</span><span class="si">{2}</span><span class="s2">&#39; &quot;</span>\
            <span class="s2">&quot;and (files.pol=&#39;VV&#39; or files.pol=&#39;HH&#39;) &quot;</span>\
            <span class="s2">&quot;order by files.name asc;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frame_files_date</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="c1"># takes frame and one datetime.date object and returns</span>
    <span class="c1"># polygon name, file name and file path for all files </span>
    <span class="c1"># in frame on the given date</span>
    
    <span class="c1">#in this mess, some scripts use date, and some timestamp or datetime..</span>
    <span class="c1">#let&#39;s convert it to date type only</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    
    <span class="c1">#this is to fix for the around-midnight data:</span>
    <span class="n">date2</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polygs.polyid_name, &quot;</span> \
        <span class="s2">&quot;files.name, files.abs_path from files &quot;</span> \
        <span class="s2">&quot;inner join files2bursts on files.fid=files2bursts.fid &quot;</span> \
        <span class="s2">&quot;inner join polygs2bursts on files2bursts.bid=polygs2bursts.bid &quot;</span> \
        <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span> \
        <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span> \
        <span class="s2">&quot;and (date(files.acq_date)=&#39;</span><span class="si">{1}</span><span class="s2">&#39; or date(files.acq_date)=&#39;</span><span class="si">{2}</span><span class="s2">&#39;)&quot;</span> \
        <span class="s2">&quot;and (pol=&#39;VV&#39; or pol=&#39;HH&#39;)&quot;</span>\
        <span class="s2">&quot;order by files.acq_date ASC, files.date_added DESC;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">date2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polyid from polygs where polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_framename_from_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polyid_name from polygs where polyid=</span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_bid_frombidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bid from bursts where bid_tanx=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_ipf</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># filename should be e.g. S1A_IW_SLC__1SSV_20141222T210739_20141222T210809_003837_00496E_C84D</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct proc_vers from files where name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_burst_no</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="c1"># takes frame and datetime.date object and returns burst numbers</span>
    <span class="c1"># return burst_id, file and number of burst in file</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx, &quot;</span> \
        <span class="s2">&quot;files.name, files2bursts.burst_no from files &quot;</span> \
        <span class="s2">&quot;inner join files2bursts on files.fid=files2bursts.fid &quot;</span> \
        <span class="s2">&quot;inner join polygs2bursts on files2bursts.bid=polygs2bursts.bid &quot;</span> \
        <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span> \
        <span class="s2">&quot;inner join bursts on polygs2bursts.bid=bursts.bid &quot;</span>\
        <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span> \
        <span class="s2">&quot;and date(files.acq_date)=&#39;</span><span class="si">{1}</span><span class="s2">&#39; &quot;</span>\
        <span class="s2">&quot;and (pol=&#39;VV&#39; or pol=&#39;HH&#39;)&quot;</span>\
        <span class="s2">&quot;order by files.acq_date;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frame_bursts_on_date</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="c1"># takes frame and datetime.date object and bursts id and center coords</span>
    <span class="c1"># for all all bursts within the frame that were acquired on that date</span>
    <span class="n">frametest</span> <span class="o">=</span> <span class="n">check_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">frametest</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Frame </span><span class="si">{0}</span><span class="s1"> not found in database&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx, bursts.centre_lon, &quot;</span>\
            <span class="s2">&quot;bursts.centre_lat from bursts &quot;</span> \
            <span class="s2">&quot;inner join polygs2bursts on polygs2bursts.bid=bursts.bid &quot;</span> \
            <span class="s2">&quot;inner join files2bursts on files2bursts.bid=bursts.bid &quot;</span>\
            <span class="s2">&quot;inner join polygs on polygs2bursts.polyid=polygs.polyid &quot;</span>\
            <span class="s2">&quot;inner join files on files2bursts.fid=files.fid &quot;</span>\
            <span class="s2">&quot;where polygs.polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span>\
            <span class="s2">&quot;and (files.pol=&#39;VV&#39; or files.pol=&#39;HH&#39;)&quot;</span>\
            <span class="s2">&quot;and date(files.acq_date)=&#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bursts_in_polygon_old</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span><span class="n">lon2</span><span class="p">,</span><span class="n">lat1</span><span class="p">,</span><span class="n">lat2</span><span class="p">,</span><span class="n">relorb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">swath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1">#swath can be provided, e.g. as &#39;S6&#39;</span>
    <span class="c1">#relorb can be provided, e.g. as 75</span>
    <span class="c1">#however this is very simplified function - if center is outside of the lat lon area, it would not find anything....</span>
    <span class="c1"># - but what to do if CEDA&#39;s mySQL is so historic it doesn&#39;t have geotables?</span>
    <span class="c1">#The GIS-enabled postgreSQL db that A.McD. was working so hard on is not used -- for ..various reasons.. but it perhaps should</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx, bursts.centre_lon, bursts.centre_lat, files.rel_orb, files.swath from bursts &quot;</span> \
        <span class="s2">&quot;inner join files2bursts on files2bursts.bid=bursts.bid &quot;</span>\
        <span class="s2">&quot;inner join files on files2bursts.fid=files.fid &quot;</span>\
        <span class="s2">&quot;where bursts.centre_lon &gt;= &#39;</span><span class="si">{0}</span><span class="s2">&#39; and bursts.centre_lon &lt;= &#39;</span><span class="si">{1}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span><span class="n">lon2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">swath</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and files.swath=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">swath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">relorb</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and files.rel_orb=</span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relorb</span><span class="p">)</span>
    <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and bursts.centre_lat &gt;= &#39;</span><span class="si">{0}</span><span class="s2">&#39; and bursts.centre_lat &lt;= &#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">lat2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bursts_in_xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">relorb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">swath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">get_bursts_in_polygon</span><span class="p">(</span><span class="n">lon</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span><span class="n">lon</span><span class="o">+</span><span class="n">tol</span><span class="p">,</span><span class="n">lat</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span><span class="n">lat</span><span class="o">+</span><span class="n">tol</span><span class="p">,</span><span class="n">relorb</span><span class="p">,</span> <span class="n">swath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">get_bursts_in_polygon</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span><span class="n">maxlon</span><span class="p">,</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">,</span><span class="n">relorb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">swath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">swath</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;IW&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">swath</span><span class="p">:</span>
            <span class="n">swath</span> <span class="o">=</span> <span class="s1">&#39;IW&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">swath</span><span class="p">)</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct b.bid_tanx from bursts b &quot;</span> \
            <span class="s2">&quot;inner join files2bursts on files2bursts.bid=b.bid &quot;</span> \
            <span class="s2">&quot;inner join files on files2bursts.fid=files.fid &quot;</span> \
            <span class="s2">&quot;where greatest ( &quot;</span> \
            <span class="s2">&quot;b.corner1_lon, b.corner2_lon, b.corner3_lon, b.corner4_lon) &gt;= </span><span class="si">{0}</span><span class="s2"> and least(&quot;</span> \
            <span class="s2">&quot;b.corner1_lon, b.corner2_lon, b.corner3_lon, b.corner4_lon) &lt;= </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span><span class="n">maxlon</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">swath</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and files.swath=&#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">swath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">relorb</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and files.rel_orb=</span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relorb</span><span class="p">)</span>
    <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and greatest( &quot;</span> \
             <span class="s2">&quot;b.corner1_lat, b.corner2_lat, b.corner3_lat, b.corner4_lat) &gt;= </span><span class="si">{0}</span><span class="s2"> and least(&quot;</span> \
             <span class="s2">&quot;b.corner1_lat, b.corner2_lat, b.corner3_lat, b.corner4_lat) &lt;= </span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frames_in_lonlat</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">minlon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">-</span><span class="n">radius</span>
    <span class="n">minlat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">-</span><span class="n">radius</span>
    <span class="n">maxlon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">+</span><span class="n">radius</span>
    <span class="n">maxlat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">+</span><span class="n">radius</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">get_frames_in_polygon</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span><span class="n">maxlon</span><span class="p">,</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frames</span>


<span class="k">def</span> <span class="nf">get_frames_in_polygon</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span><span class="n">maxlon</span><span class="p">,</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct p.polyid_name from polygs p inner join polygs2bursts pb on p.polyid=pb.polyid &quot;</span> \
            <span class="s2">&quot;inner join bursts b on pb.bid=b.bid where greatest( &quot;</span> \
            <span class="s2">&quot;b.corner1_lon, b.corner2_lon, b.corner3_lon, b.corner4_lon) &gt;= </span><span class="si">{0}</span><span class="s2"> and least(&quot;</span> \
            <span class="s2">&quot;b.corner1_lon, b.corner2_lon, b.corner3_lon, b.corner4_lon) &lt;= </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span><span class="n">maxlon</span><span class="p">)</span>
    <span class="n">sql_q</span> <span class="o">+=</span> <span class="s2">&quot;and greatest( &quot;</span> \
             <span class="s2">&quot;b.corner1_lat, b.corner2_lat, b.corner3_lat, b.corner4_lat) &gt;= </span><span class="si">{0}</span><span class="s2"> and least(&quot;</span> \
             <span class="s2">&quot;b.corner1_lat, b.corner2_lat, b.corner3_lat, b.corner4_lat) &lt;= </span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frames_with_burst</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct p.polyid_name from polygs p inner join polygs2bursts pb on p.polyid=pb.polyid inner join bursts b on pb.bid=b.bid where b.bid_tanx = &#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_frames_in_orbit</span><span class="p">(</span><span class="n">relorb</span><span class="p">,</span> <span class="n">orbdir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">relorb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">relorb</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">relorb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">relorb</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="n">relorb</span>
    <span class="k">if</span> <span class="n">orbdir</span><span class="p">:</span>
        <span class="c1">#e.g. 124D</span>
        <span class="n">relorb</span> <span class="o">=</span> <span class="n">relorb</span><span class="o">+</span><span class="n">orbdir</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct polyid_name from polygs where polyid_name LIKE &#39;</span><span class="si">{}</span><span class="s2">%&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relorb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_files_from_burst</span><span class="p">(</span><span class="n">burstid</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct bursts.bid_tanx, files.abs_path from bursts &quot;</span> \
        <span class="s2">&quot;inner join files2bursts on files2bursts.bid=bursts.bid &quot;</span>\
        <span class="s2">&quot;inner join files on files2bursts.fid=files.fid &quot;</span>\
        <span class="s2">&quot;where bursts.bid_tanx = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">burstid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_filenames_from_burst</span><span class="p">(</span><span class="n">burstid</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select distinct files.name from bursts &quot;</span> \
        <span class="s2">&quot;inner join files2bursts on files2bursts.bid=bursts.bid &quot;</span>\
        <span class="s2">&quot;inner join files on files2bursts.fid=files.fid &quot;</span>\
        <span class="s2">&quot;where bursts.bid_tanx = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">burstid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>


<div class="viewcode-block" id="get_orbdir_from_bidtanx"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.get_orbdir_from_bidtanx">[docs]</a><span class="k">def</span> <span class="nf">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get string &#39;A&#39; or &#39;D&#39; for ascending/descending</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bidtanx (str): LiCSAR S1 Burst ID (e.g. &#39;127_IW1_20509&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select f.orb_dir from files f inner join files2bursts fb &quot;</span> \
        <span class="s2">&quot;on f.fid=fb.fid inner join bursts b on fb.bid=b.bid &quot;</span> \
        <span class="s2">&quot;where b.bid_tanx=&#39;</span><span class="si">{0}</span><span class="s2">&#39; limit 1;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<span class="k">def</span> <span class="nf">get_polygon</span><span class="p">(</span><span class="n">polyid_nm</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;SELECT corner1_lon, corner1_lat, corner2_lon, corner2_lat, &quot;</span> \
        <span class="s2">&quot;corner3_lon, corner3_lat, corner4_lon, corner4_lat, &quot;</span> \
        <span class="s2">&quot;corner5_lon, corner5_lat, corner6_lon, corner6_lat, &quot;</span> \
        <span class="s2">&quot;corner7_lon, corner7_lat, corner8_lon, corner8_lat, &quot;</span> \
        <span class="s2">&quot;corner9_lon, corner9_lat, corner10_lon, corner10_lat, &quot;</span> \
        <span class="s2">&quot;corner11_lon, corner11_lat, corner12_lon, corner12_lat &quot;</span> \
        <span class="s2">&quot;FROM polygs where polyid_name = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">polyid_nm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_time_of_file</span><span class="p">(</span><span class="n">fileID</span><span class="p">):</span>
    <span class="c1">#takes file ID like e.g. S1B_IW_SLC__1SDV_20190808T040601_20190808T040628_017489_020E3F_C558</span>
    <span class="c1">#and gets the full time of its acquisition, not only date..</span>
    <span class="c1">#you may get the file ID e.g. using</span>
    <span class="c1">#date=datetime.strptime(&#39;2019-08-08&#39;,&#39;%Y-%m-%d&#39;)</span>
    <span class="c1">#filelist = get_frame_files_date(frame, date.date())</span>
    <span class="c1">#fileID = filelist[0][1]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;SELECT acq_date from files where name =&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_wkt_boundaries</span><span class="p">(</span><span class="n">frameName</span><span class="p">):</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">get_polygon</span><span class="p">(</span><span class="n">frameName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">frame_poly_cor</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">framepoly</span> <span class="ow">in</span> <span class="n">polygon</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">framepoly</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame_poly_cor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">framepoly</span><span class="p">)</span>
        <span class="n">frame_poly</span> <span class="o">=</span> <span class="n">frame_poly_cor</span>
        <span class="n">frame_poly_zip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">frame_poly</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">frame_poly</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
    <span class="c1">#first is lon, second is lat</span>
    <span class="n">minlon</span> <span class="o">=</span> <span class="n">minlat</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">maxlon</span> <span class="o">=</span> <span class="n">maxlat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span>
    <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">frame_poly_zip</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lon</span> <span class="o">&lt;</span> <span class="n">minlon</span><span class="p">:</span> <span class="n">minlon</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lon</span> <span class="o">&gt;</span> <span class="n">maxlon</span><span class="p">:</span> <span class="n">maxlon</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lat</span> <span class="o">&lt;</span> <span class="n">minlat</span><span class="p">:</span> <span class="n">minlat</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lat</span> <span class="o">&gt;</span> <span class="n">maxlat</span><span class="p">:</span> <span class="n">maxlat</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">polyText</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minlon</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minlat</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span> \
               <span class="nb">str</span><span class="p">(</span><span class="n">minlon</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">maxlat</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span> \
               <span class="nb">str</span><span class="p">(</span><span class="n">maxlon</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">maxlat</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span> \
               <span class="nb">str</span><span class="p">(</span><span class="n">maxlon</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minlat</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span> \
               <span class="nb">str</span><span class="p">(</span><span class="n">minlon</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minlat</span><span class="p">)</span>
    <span class="n">wkt</span> <span class="o">=</span> <span class="s1">&#39;POLYGON((</span><span class="si">{0}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyText</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wkt</span>


<span class="k">def</span> <span class="nf">is_in_polygs2geom</span><span class="p">(</span><span class="n">frameid</span><span class="p">):</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frameid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">polyid</span><span class="p">:</span>
        <span class="n">polyid</span> <span class="o">=</span> <span class="n">polyid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error - the frame ID does not exist?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">is_in_geom_sql</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from polygs2gis where polyid = </span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">polyid</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">is_in_geom_sql</span><span class="p">)</span>
    <span class="n">is_in_geom</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_in_geom</span>


<span class="k">def</span> <span class="nf">is_in_bursts2geom</span><span class="p">(</span><span class="n">s1bid</span><span class="p">,</span> <span class="n">iw</span><span class="p">):</span>
    <span class="n">is_in_geom_sql</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from s1bursts where s1bid = </span><span class="si">{0}</span><span class="s2"> and iw = </span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s1bid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">iw</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">is_in_geom_sql</span><span class="p">)</span>
    <span class="n">is_in_geom</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_in_geom</span>


<span class="k">def</span> <span class="nf">is_in_table</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">is_in_sql</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from </span><span class="si">{0}</span><span class="s2"> where </span><span class="si">{1}</span><span class="s2"> = &#39;</span><span class="si">{2}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_in_sql</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from </span><span class="si">{0}</span><span class="s2"> where </span><span class="si">{1}</span><span class="s2"> = </span><span class="si">{2}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">is_in_sql</span><span class="p">)</span>
    <span class="n">is_in</span><span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">is_in</span>


<span class="k">def</span> <span class="nf">set_job_started</span><span class="p">(</span><span class="n">job_id</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE jobs &quot;</span>\
        <span class="s2">&quot;SET licsar_version = &#39;</span><span class="si">%s</span><span class="s2">&#39; , &quot;</span> \
        <span class="s2">&quot;  time_started = IF( &quot;</span>\
        <span class="s2">&quot;  time_started IS NULL, &quot;</span> \
        <span class="s2">&quot;  NOW(), &quot;</span> \
        <span class="s2">&quot;  time_started &quot;</span>\
        <span class="s2">&quot;), &quot;</span> \
        <span class="s2">&quot;job_status = 2 &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;VERSION&#39;</span><span class="p">],</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_job_request_started_master</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span>\
        <span class="s2">&quot;SET jr_status = 19 &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND acq_date = DATE(</span><span class="si">%s</span><span class="s2">) ;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_job_request_started_standard</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span>\
        <span class="s2">&quot;SET jr_status = 59 &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND acq_date = DATE(</span><span class="si">%s</span><span class="s2">) ;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_job_finished</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">ec</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE jobs &quot;</span>\
        <span class="s2">&quot;SET time_finished = NOW(), &quot;</span>\
        <span class="s2">&quot; job_status = CASE &quot;</span> \
        <span class="s2">&quot;  WHEN </span><span class="si">%d</span><span class="s2"> = 0 THEN 3 &quot;</span> \
        <span class="s2">&quot;  WHEN </span><span class="si">%d</span><span class="s2"> &gt; 0 AND </span><span class="si">%d</span><span class="s2"> &lt; ( &quot;</span>\
        <span class="s2">&quot;    SELECT COUNT(jr_id) FROM job_requests WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span>\
        <span class="s2">&quot;    ) &quot;</span>\
        <span class="s2">&quot;    THEN 4 &quot;</span> \
        <span class="s2">&quot;  WHEN </span><span class="si">%d</span><span class="s2"> &gt; 0 AND </span><span class="si">%d</span><span class="s2"> = ( &quot;</span> \
        <span class="s2">&quot;    SELECT COUNT(jr_id) FROM job_requests WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;    ) &quot;</span> \
        <span class="s2">&quot;    THEN 5 &quot;</span> \
        <span class="s2">&quot;  ELSE 9 &quot;</span>\
        <span class="s2">&quot; END &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> ;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">set_error_for_unclean_job_finishes</span><span class="p">(</span><span class="n">job_id</span><span class="p">):</span>
    <span class="c1"># If a job fails for an unknown reason and doesn&#39;t put an error code in the job_requests table, tidy it up with an</span>
    <span class="c1"># appropriate error code to indicate it died and the error was not caught properly.</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span> \
        <span class="s2">&quot;SET jr_status = 999 &quot;</span> \
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND jr_status = 59;&quot;</span> <span class="o">%</span> <span class="n">job_id</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">store_frame_geometry</span><span class="p">(</span><span class="n">frameid</span><span class="p">,</span> <span class="n">wkt</span><span class="p">):</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frameid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">polyid</span><span class="p">:</span>
        <span class="n">polyid</span> <span class="o">=</span> <span class="n">polyid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error - the frame ID does not exist?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">is_in_geom</span> <span class="o">=</span> <span class="n">is_in_polygs2geom</span><span class="p">(</span><span class="n">frameid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_in_geom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE polygs2gis set geom=GeomFromText(&#39;</span><span class="si">{0}</span><span class="s2">&#39;) where polyid=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wkt</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">polyid</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO polygs2gis VALUES (</span><span class="si">{0}</span><span class="s2">, GeomFromText(&#39;</span><span class="si">{1}</span><span class="s2">&#39;));&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">polyid</span><span class="p">),</span> <span class="n">wkt</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">CREATE TABLE s1bursts</span>
<span class="sd">(id INT(8) UNSIGNED PRIMARY KEY NOT NULL AUTO_INCREMENT,</span>
<span class="sd"> s1bid INT(8) UNSIGNED NOT NULL,</span>
<span class="sd"> iw TINYINT(1) NOT NULL,</span>
<span class="sd"> relorb TINYINT(3) UNSIGNED NOT NULL,</span>
<span class="sd"> tanx FLOAT(11) NOT NULL,</span>
<span class="sd"> opass CHAR(1) NOT NULL,</span>
<span class="sd"> geometry POLYGON NOT NULL);</span>

<span class="sd">.. then:</span>
<span class="sd">for i,j in aa.iterrows():</span>
<span class="sd">    print(i)</span>
<span class="sd">    res = store_burst_geom(j[0], int(j[1][-1]), j[2], j[3], j[4][0], j[5].wkt)</span>



<span class="sd">CREATE TABLE volcanoes</span>
<span class="sd">(volc_id INT(8) UNSIGNED PRIMARY KEY NOT NULL,</span>
<span class="sd"> name VARCHAR(40) NOT NULL,</span>
<span class="sd"> lat FLOAT(7,5) NOT NULL,</span>
<span class="sd"> lon FLOAT(8,5) NOT NULL,</span>
<span class="sd"> alt FLOAT(5,1) NULL,</span>
<span class="sd"> priority CHAR(2) NULL,</span>
<span class="sd"> geometry POINT NULL);</span>

<span class="sd">for i,j in a.iterrows():</span>
<span class="sd">    print(i)</span>
<span class="sd">    res=store_volcano_to_db(j[0], j[1], j[2], j[3], j[4])</span>


<span class="sd">for i,j in b.iterrows():</span>
<span class="sd">    print(i)</span>
<span class="sd">    res=store_volcano_to_db(j[0], j[1], j[2], j[3], j[4])</span>


<span class="sd">    #, j.priority)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">store_volcano_to_db</span><span class="p">(</span><span class="n">volcid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">volcid</span><span class="p">,</span> <span class="s1">&#39;volc_id&#39;</span><span class="p">,</span> <span class="s1">&#39;volcanoes&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;volcano &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">volcid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; already exists in db&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">priority</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO volcanoes (volc_id, name, lat, lon, alt, priority, geometry) VALUES (</span><span class="si">{0}</span><span class="s2">, &#39;</span><span class="si">{1}</span><span class="s2">&#39;, </span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3}</span><span class="s2">, </span><span class="si">{4}</span><span class="s2">, &#39;</span><span class="si">{5}</span><span class="s2">&#39;, GeomFromText(&#39;POINT </span><span class="si">{3}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&#39;));&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">volcid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">priority</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO volcanoes (volc_id, name, lat, lon, alt, geometry) VALUES (</span><span class="si">{0}</span><span class="s2">, &#39;</span><span class="si">{1}</span><span class="s2">&#39;, </span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3}</span><span class="s2">, </span><span class="si">{4}</span><span class="s2">, GeomFromText(&#39;POINT </span><span class="si">{3}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&#39;));&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">volcid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">store_burst_geom</span><span class="p">(</span><span class="n">s1bid</span><span class="p">,</span> <span class="n">iw</span><span class="p">,</span> <span class="n">relorb</span><span class="p">,</span> <span class="n">tanx</span><span class="p">,</span> <span class="n">opass</span><span class="p">,</span> <span class="n">wkt</span><span class="p">,</span> <span class="n">checkisin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">checkisin</span><span class="p">:</span>
        <span class="n">is_in_geom</span> <span class="o">=</span> <span class="n">is_in_bursts2geom</span><span class="p">(</span><span class="n">s1bid</span><span class="p">,</span> <span class="n">iw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_in_geom</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO s1bursts (s1bid, iw, relorb, tanx, opass, geometry) VALUES (</span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3}</span><span class="s2">, &#39;</span><span class="si">{4}</span><span class="s2">&#39;, GeomFromText(&#39;</span><span class="si">{5}</span><span class="s2">&#39;));&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s1bid</span><span class="p">),</span> 
                                <span class="nb">str</span><span class="p">(</span><span class="n">iw</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">relorb</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tanx</span><span class="p">),</span> <span class="n">opass</span><span class="p">,</span> <span class="n">wkt</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>



<span class="k">def</span> <span class="nf">sqlout2list</span><span class="p">(</span><span class="n">insql</span><span class="p">):</span>
    <span class="c1">#in case we get only string, we assume it was an error</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">insql</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;str&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">insql</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># DEPRECATED - delete after testing its replacement</span>
<span class="c1"># def set_job_finished_clean(job_id):</span>
<span class="c1">#     sql_q = &quot;UPDATE jobs &quot;\</span>
<span class="c1">#         &quot;SET time_finished = NOW(), &quot;\</span>
<span class="c1">#         &quot; job_status = 3 &quot;\</span>
<span class="c1">#         &quot;WHERE job_id = %d;&quot; % (job_id)</span>
<span class="c1">#</span>
<span class="c1">#     # perform query, get result (should be blank), and then commit the transaction</span>
<span class="c1">#     res = do_query(sql_q)</span>
<span class="c1">#     conn.commit()</span>
<span class="c1">#</span>
<span class="c1">#     return</span>


<span class="k">def</span> <span class="nf">set_job_request_finished_clean</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span>\
        <span class="s2">&quot;SET jr_status = 0 &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND acq_date = DATE(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="c1"># DEPRECATED - delete after testing its replacement</span>
<span class="c1"># def set_job_finished_error(job_id, status=9):</span>
<span class="c1">#     sql_q = &quot;UPDATE jobs &quot;\</span>
<span class="c1">#         &quot;SET time_finished = NOW(), &quot;\</span>
<span class="c1">#         &quot; job_status = %d &quot;\</span>
<span class="c1">#         &quot;WHERE job_id = %d;&quot; % (status, job_id)</span>
<span class="c1">#</span>
<span class="c1">#     # perform query, get result (should be blank), and then commit the transaction</span>
<span class="c1">#     res = do_query(sql_q)</span>
<span class="c1">#     conn.commit()</span>
<span class="c1">#</span>
<span class="c1">#     return</span>
    

<span class="k">def</span> <span class="nf">set_job_request_finished_master_fail</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">101</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span>\
        <span class="s2">&quot;SET jr_status = </span><span class="si">%d</span><span class="s2"> &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND acq_date = DATE(</span><span class="si">%s</span><span class="s2">) ;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_job_request_finished_standard_fail</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">501</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE job_requests &quot;</span>\
        <span class="s2">&quot;SET jr_status = </span><span class="si">%d</span><span class="s2"> &quot;</span>\
        <span class="s2">&quot;WHERE job_id = </span><span class="si">%d</span><span class="s2"> &quot;</span> \
        <span class="s2">&quot;AND acq_date = DATE(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_files2jobs</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">file_list</span><span class="p">):</span>
    <span class="c1"># check data types and convert it to a list of strings as required, log errors of unexepcted data types</span>
    <span class="c1"># these errors should only be reported if our code is supplying variable data types.</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">file_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">]</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ziplist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Expected list of strings, but got list of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Expected list of string, but got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>


    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO files2jobs &quot;</span>\
        <span class="s2">&quot;(fid, job_id) &quot;</span>\
        <span class="s2">&quot;SELECT fid, </span><span class="si">%d</span><span class="s2"> &quot;</span>\
        <span class="s2">&quot;FROM files &quot;</span>\
        <span class="s2">&quot;WHERE abs_path &quot;</span>\
        <span class="s2">&quot;IN (</span><span class="si">%s</span><span class="s2">); &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">ziplist</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_new_rslc_product</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">,</span> <span class="n">master_rslc_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">rslc_status</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">master_rslc_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO rslc &quot;</span>\
            <span class="s2">&quot;(polyid, filename, filepath, job_id, acq_date, master_rslc_id, rslc_status) &quot;</span>\
            <span class="s2">&quot;SELECT polyid, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%d</span><span class="s2">, date(</span><span class="si">%s</span><span class="s2">), </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> &quot;</span>\
            <span class="s2">&quot;FROM jobs WHERE job_id = </span><span class="si">%d</span><span class="s2">;&quot;</span><span class="o">%</span> <span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">,</span> <span class="n">master_rslc_id</span><span class="p">,</span>
                                              <span class="n">rslc_status</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO rslc &quot;</span> \
                <span class="s2">&quot;(polyid, filename, filepath, job_id, acq_date, master_rslc_id, rslc_status) &quot;</span> \
                <span class="s2">&quot;SELECT j.polyid, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%d</span><span class="s2">, date(</span><span class="si">%s</span><span class="s2">), rm.rslc_id, </span><span class="si">%d</span><span class="s2"> &quot;</span> \
                <span class="s2">&quot;FROM jobs  AS j &quot;</span>\
                <span class="s2">&quot;  JOIN rslc AS rm&quot;</span> \
                <span class="s2">&quot;   ON rm.filepath=&#39;</span><span class="si">%s</span><span class="s2">&#39; AND rm.rslc_status=0 &quot;</span>\
                <span class="s2">&quot;WHERE j.job_id = </span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">acq_date</span><span class="p">,</span> <span class="n">rslc_status</span><span class="p">,</span>
                                        <span class="n">master_rslc_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_new_ifg_product</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">rslc_path_1</span><span class="p">,</span> <span class="n">rslc_path_2</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">ifg_status</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO ifg &quot;</span>\
            <span class="s2">&quot;    (polyid, rslc_id_1, acq_date_1, rslc_id_2, acq_date_2, date_gap, filename, filepath, job_id, ifg_status) &quot;</span>\
            <span class="s2">&quot;SELECT &quot;</span>\
            <span class="s2">&quot;    j.polyid, &quot;</span>\
            <span class="s2">&quot;    r1.rslc_id, &quot;</span>\
            <span class="s2">&quot;    r1.acq_date, &quot;</span>\
            <span class="s2">&quot;    r2.rslc_id, &quot;</span>\
            <span class="s2">&quot;    r2.acq_date, &quot;</span>\
            <span class="s2">&quot;    DATEDIFF(r2.acq_date, r1.acq_date), &quot;</span>\
            <span class="s2">&quot;    &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>\
            <span class="s2">&quot;    &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>\
            <span class="s2">&quot;    </span><span class="si">%d</span><span class="s2">, &quot;</span>\
            <span class="s2">&quot;    </span><span class="si">%d</span><span class="s2"> &quot;</span>\
            <span class="s2">&quot;FROM jobs as j &quot;</span>\
            <span class="s2">&quot;    JOIN rslc as r1 ON &quot;</span>\
            <span class="s2">&quot;        r1.filepath=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>\
            <span class="s2">&quot;    AND &quot;</span>\
            <span class="s2">&quot;        r1.rslc_status=0 &quot;</span>\
            <span class="s2">&quot;    JOIN rslc as r2 ON &quot;</span>\
            <span class="s2">&quot;        r2.filepath=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>\
            <span class="s2">&quot;    AND &quot;</span>\
            <span class="s2">&quot;        r2.rslc_status=0 &quot;</span>\
            <span class="s2">&quot;WHERE j.job_id=</span><span class="si">%d</span><span class="s2">; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">ifg_status</span><span class="p">,</span> <span class="n">rslc_path_1</span><span class="p">,</span> <span class="n">rslc_path_2</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">update_ifg_product_unwrapped</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE ifg SET unwrapped=</span><span class="si">%d</span><span class="s2"> WHERE job_id=</span><span class="si">%d</span><span class="s2"> AND filename=&#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;eq2frame&#39;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;coifg_status&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;fid=1&#39;</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;UPDATE </span><span class="si">{0}</span><span class="s2"> SET </span><span class="si">{1}</span><span class="s2">=</span><span class="si">{2}</span><span class="s2"> WHERE </span><span class="si">{3}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">set_new_coherence_product</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">rslc_path_1</span><span class="p">,</span> <span class="n">rslc_path_2</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">coh_status</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO coherence &quot;</span> \
            <span class="s2">&quot;    (polyid, rslc_id_1, acq_date_1, rslc_id_2, acq_date_2, date_gap, filename, filepath, job_id, coh_status) &quot;</span> \
            <span class="s2">&quot;SELECT &quot;</span> \
            <span class="s2">&quot;    j.polyid, &quot;</span> \
            <span class="s2">&quot;    r1.rslc_id, &quot;</span> \
            <span class="s2">&quot;    r1.acq_date, &quot;</span> \
            <span class="s2">&quot;    r2.rslc_id, &quot;</span> \
            <span class="s2">&quot;    r2.acq_date, &quot;</span> \
            <span class="s2">&quot;    DATEDIFF(r2.acq_date, r1.acq_date), &quot;</span> \
            <span class="s2">&quot;    &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> \
            <span class="s2">&quot;    &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> \
            <span class="s2">&quot;    </span><span class="si">%d</span><span class="s2">, &quot;</span> \
            <span class="s2">&quot;    </span><span class="si">%d</span><span class="s2"> &quot;</span> \
            <span class="s2">&quot;FROM jobs as j &quot;</span> \
            <span class="s2">&quot;    JOIN rslc as r1 ON &quot;</span> \
            <span class="s2">&quot;        r1.filepath=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> \
            <span class="s2">&quot;    AND &quot;</span> \
            <span class="s2">&quot;        r1.rslc_status=0 &quot;</span> \
            <span class="s2">&quot;    JOIN rslc as r2 ON &quot;</span> \
            <span class="s2">&quot;        r2.filepath=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> \
            <span class="s2">&quot;    AND &quot;</span> \
            <span class="s2">&quot;        r2.rslc_status=0 &quot;</span> \
            <span class="s2">&quot;WHERE j.job_id=</span><span class="si">%d</span><span class="s2">; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">coh_status</span><span class="p">,</span> <span class="n">rslc_path_1</span><span class="p">,</span> <span class="n">rslc_path_2</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">get_eqid</span><span class="p">(</span><span class="n">eventid</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select eqid from eq where USGS_ID=&#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eventid</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="get_daz"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.get_daz">[docs]</a><span class="k">def</span> <span class="nf">get_daz</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">getall</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets values from the ESD database table for given frame and epoch.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        polyid (int):   frame polyid</span>
<span class="sd">        epoch (str):    epoch, e.g. &#39;20211022&#39;</span>
<span class="sd">        getall (bool):  if True, will return all values, not only azimuth offset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">getall</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select daz from esd where polyid=</span><span class="si">{}</span><span class="s2"> and epoch=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span><span class="n">epoch</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">daz</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">daz</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select * from esd where polyid=</span><span class="si">{}</span><span class="s2"> and epoch=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span><span class="n">epoch</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="delete_esds_for_frame"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.delete_esds_for_frame">[docs]</a><span class="k">def</span> <span class="nf">delete_esds_for_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In case of removing a frame, ensure the esd values are also purged.</span>
<span class="sd">    (by default, if epoch already exists in esd database, it would not be overwritten)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        frame (str): 	frame ID</span>
<span class="sd">        epoch (str): 	epoch, e.g. &#39;20210122&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;do not use if you do not intend to fully recreate the frame, i.e. if esds are that bad&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;delete from esd where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;delete from esd where polyid=</span><span class="si">{}</span><span class="s2"> and epoch=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In total, </span><span class="si">{}</span><span class="s1"> records were deleted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="ingest_esd"><a class="viewcode-back" href="../../../../licsar_proc/apidoc.html#licsar_proc.python.LiCSAR_db.LiCSquery.ingest_esd">[docs]</a><span class="k">def</span> <span class="nf">ingest_esd</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">rslc3</span><span class="p">,</span> <span class="n">daz</span><span class="p">,</span> <span class="n">ccazi</span><span class="p">,</span> <span class="n">ccrg</span><span class="p">,</span> <span class="n">orb</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to import ESD (etc.) values to the database</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        frame (str): 	frame ID</span>
<span class="sd">        epoch (str): 	epoch, e.g. &#39;20210122&#39;</span>
<span class="sd">        rslc3 (str):	epoch that was used as RSLC3, e.g. &#39;20210110&#39;</span>
<span class="sd">        daz (float):	$\Delta a$ [px] offset w.r.t. orbits (i.e. total azimuth offset, sd_daz+icc_daz)</span>
<span class="sd">        ccazi (float):	$\Delta a_{ICC}$ [px] offset from intensity/incoherent cross-correlation (ICC) in azimuth</span>
<span class="sd">        ccrg (float):	$\Delta r_{ICC}$ [px] offset from intensity/incoherent cross-correlation (ICC) in range</span>
<span class="sd">        orb (str):		orbit file used here (e.g. S1A_POE_.....zip) - special value &#39;fixed_as_in_GRL&#39; means imported from older data and fixed</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dazdb</span> <span class="o">=</span> <span class="n">get_daz</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dazdb</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">daz</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">!=</span><span class="nb">round</span><span class="p">(</span><span class="n">dazdb</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="c1">#clean it first</span>
            <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;delete from esd where polyid=</span><span class="si">{}</span><span class="s2"> and epoch=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the record exists, skipping&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="c1">#the DATE in MySQL is pretty flexible... so using just the values directly:</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;insert into esd values (</span><span class="si">{}</span><span class="s2">, &#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">&#39;, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">rslc3</span><span class="p">,</span> <span class="n">orb</span><span class="p">,</span> <span class="n">daz</span><span class="p">,</span> <span class="n">ccazi</span><span class="p">,</span> <span class="n">ccrg</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">update_esd</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">colupdate</span> <span class="o">=</span> <span class="s1">&#39;daz&#39;</span><span class="p">,</span> <span class="n">valupdate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">sqlout2list</span><span class="p">(</span><span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">valupdate</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">):</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;update esd set </span><span class="si">{0}</span><span class="s2"> = &#39;</span><span class="si">{1}</span><span class="s2">&#39; where polyid=</span><span class="si">{2}</span><span class="s2"> and epoch = &#39;</span><span class="si">{3}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colupdate</span><span class="p">,</span> <span class="n">valupdate</span><span class="p">,</span> <span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;update esd set </span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="s2"> where polyid=</span><span class="si">{2}</span><span class="s2"> and epoch = &#39;</span><span class="si">{3}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colupdate</span><span class="p">,</span> <span class="n">valupdate</span><span class="p">,</span> <span class="n">polyid</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">get_usgsid</span><span class="p">(</span><span class="n">eqid</span><span class="p">):</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;select USGS_ID from eq where eqid=</span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eqid</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">insert_new_eq</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">stract</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stract</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
    <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO eq &quot;</span> \
            <span class="s2">&quot;    (USGS_ID, magnitude, location, depth, time, lat, lon, active) &quot;</span> \
            <span class="s2">&quot;VALUES (&#39;</span><span class="si">{0}</span><span class="s2">&#39;,</span><span class="si">{1}</span><span class="s2">,&#39;</span><span class="si">{2}</span><span class="s2">&#39;,</span><span class="si">{3}</span><span class="s2">,&#39;</span><span class="si">{4}</span><span class="s2">&#39;,</span><span class="si">{5}</span><span class="s2">, </span><span class="si">{6}</span><span class="s2">, </span><span class="si">{7}</span><span class="s2">);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
            <span class="n">event</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">stract</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">get_eqid</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error happened - eq was not saved to database&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">insert_new_eq2frame</span><span class="p">(</span><span class="n">eqid</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">post_acq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">stract</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stract</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
    <span class="k">if</span> <span class="n">post_acq</span><span class="p">:</span>
        <span class="n">next_acq</span> <span class="o">=</span> <span class="n">post_acq</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">last_acq</span> <span class="o">=</span> <span class="n">post_acq</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO eq2frame &quot;</span> \
            <span class="s2">&quot;    (eqid, fid, frame_status, post_acq, coifg_status, next_acq, last_acq, postifg_status, active) &quot;</span> \
            <span class="s2">&quot;VALUES (</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">,1,&#39;</span><span class="si">{2}</span><span class="s2">&#39;,1,&#39;</span><span class="si">{3}</span><span class="s2">&#39;,&#39;</span><span class="si">{4}</span><span class="s2">&#39;, 1, </span><span class="si">{5}</span><span class="s2">);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eqid</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">post_acq</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span> 
            <span class="n">next_acq</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span> <span class="n">last_acq</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span> <span class="n">stract</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql_q</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO eq2frame &quot;</span> \
        <span class="s2">&quot;    (eqid, fid)&quot;</span> \
        <span class="s2">&quot;VALUES (</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eqid</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>
    <span class="c1"># perform query, get result (should be blank), and then commit the transaction</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_query</span><span class="p">(</span><span class="n">sql_q</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, COMET and CEMAC teams.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>